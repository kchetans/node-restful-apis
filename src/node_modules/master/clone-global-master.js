let master = require('./index').fun;
let _      = require('lodash');
let models = require('sql-models');

let a = {
    async createCountry(csid){

        /** Required columns from table**/
        let requiredColumns = ["name", "code"];

        /** Create Country Master **/
        let newMaster = await master.createMaster({csid, code: 'country', title: 'Country'});

        let master_id = parseInt(newMaster.id);

        /** Creating Headers Data **/
        let headersObjects = _.map(requiredColumns, field => {
            return {code: _.snakeCase(field), title: _.capitalize(field), master_id}
        });

        /** Create Headers**/
        await models.db.master_headers.bulkCreate(headersObjects);

        /** Created Headers Object from DB**/
        let createdHeaders = await models.db.master_headers.findAll();

        let createdHeadersMap = new Map();
        _.map(createdHeaders, createdHeader => createdHeadersMap.set(createdHeader.code, createdHeader.id));

        let allCountry = await models.db.country.findAll();

        let dataObjects = [];

        _.map(allCountry, (country, countryIndex) => {
            let requiredFieldValues = [country.name, country.code];
            _.map(requiredFieldValues, (value, valueIndex) => {
                let header_id = createdHeadersMap.get(requiredColumns[valueIndex]);
                dataObjects.push({value, row_id: countryIndex, header_id})
            });
        });

        await models.db.master_data.bulkCreate(dataObjects);

        return "OK";
    },

    async createState(csid){
        /** Required columns from table**/
        let requiredColumns = ["name", "code"];

        /** Create Country Master **/
        let newMaster = await master.createMaster({csid, code: 'state', title: 'State'});

        let master_id = parseInt(newMaster.id);

        /** Creating Headers Data **/
        let headersObjects = _.map(requiredColumns, field => {
            return {code: _.snakeCase(field), title: _.capitalize(field), master_id}
        });

        /** Create Headers**/
        await models.db.master_headers.bulkCreate(headersObjects);

        /** Created Headers Object from DB**/
        let createdHeaders = await models.db.master_headers.findAll();

        let createdHeadersMap = new Map();
        _.map(createdHeaders, createdHeader => createdHeadersMap.set(createdHeader.code, createdHeader.id));

        let allCountry = await models.db.country.findAll();

        let dataObjects = [];

        _.map(allCountry, (country, countryIndex) => {
            let requiredFieldValues = [country.name, country.code];
            _.map(requiredFieldValues, (value, valueIndex) => {
                let header_id = createdHeadersMap.get(requiredColumns[valueIndex]);
                dataObjects.push({value, row_id: countryIndex, header_id})
            });
        });

        await models.db.master_data.bulkCreate(dataObjects);

        return "OK";
    }
};


module.exports = function (csid) {
    a.createCountry(csid);
    a.createState(csid);
};
